<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CrossFit Leaderboard</title>
    
    <!-- SEO & Social Media Meta Tags -->
    <meta name="description" content="Sprawd藕 wyniki zawod贸w CrossFit. Ranking trening贸w, statystyki i compete z innymi zawodnikami!">
    
    <!-- Open Graph (Facebook, WhatsApp, LinkedIn) -->
    <meta property="og:title" content="CrossFit Leaderboard">
    <meta property="og:description" content="Sprawd藕 wyniki zawod贸w CrossFit. Ranking trening贸w, statystyki i compete z innymi zawodnikami!">
    <meta property="og:image" content="https://img.freepik.com/darmowe-zdjecie/grupa-crossfit-w-silowni_53876-13630.jpg">
    <meta property="og:url" content="https://crossfitleaderboard.online">
    <meta property="og:type" content="website">
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="CrossFit Leaderboard">
    <meta name="twitter:description" content="Sprawd藕 wyniki zawod贸w CrossFit. Ranking trening贸w, statystyki i compete z innymi zawodnikami!">
    <meta name="twitter:image" content="https://img.freepik.com/darmowe-zdjecie/grupa-crossfit-w-silowni_53876-13630.jpg">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div style="position: relative; margin-bottom: 30px;">
            <a href="admin-panel.html" 
               style="position: absolute; top: 0; right: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px 24px; text-decoration: none; border-radius: 8px; font-weight: 600; font-size: 15px; white-space: nowrap; transition: transform 0.2s; display: inline-block;"
               onmouseover="this.style.transform='translateY(-2px)'" 
               onmouseout="this.style.transform='translateY(0)'">
                 Panel admina
            </a>
            
            <h1 style="margin: 0; text-align: center; font-size: 3rem; padding: 10px 0;">CrossFit Leaderboard</h1>
        </div>

        <a href="add-result.html" 
           class="add-score-btn">
            Dodaj sw贸j wynik
        </a>

        <div class="controls">
            <div class="control-row">
                <div class="control-item">
                    <label for="searchInput">Wyszukaj zawodnika</label>
                    <input type="text" id="searchInput" placeholder="Wpisz imi...">
                </div>
                <div class="control-item">
                    <label for="wodSelect">Wybierz trening</label>
                    <select id="wodSelect">
                        <option value="">adowanie...</option>
                    </select>
                </div>
            </div>
        </div>

        <div id="loading">adowanie wynik贸w...</div>

        <div class="table-container">
            <table id="resultsTable" style="display:none;">
                <thead>
                    <tr>
                        <th onclick="sortTable(0)">Zawodnik</th>
                        <th onclick="sortTable(1)">Kategoria</th>
                        <th onclick="sortTable(2)">Trening</th>
                        <th onclick="sortTable(3)">Wynik</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // === KONFIGURACJA SUPABASE ===
        const SUPABASE_URL = 'https://xaqghgehuqjtpzzjihrl.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhhcWdoZ2VodXFqdHB6emppaHJsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkwMjE0NDAsImV4cCI6MjA4NDU5NzQ0MH0.xyVj7UWVH6SvTKEHJH-RL57YcpBfp_7rrhtzjfdvYyQ';
        
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        let allWods = [];
        let allResults = [];

        // Inicjalizacja aplikacji
        async function initApp() {
            try {
                // Pobierz WOD-y
                const { data: wods, error: wodsError } = await supabaseClient
                    .from('wods')
                    .select('*');
                
                if (wodsError) throw wodsError;
                allWods = wods;
                
                document.getElementById('loading').style.display = 'none';
                populateDropdown();
            } catch (error) {
                document.getElementById('loading').textContent = 'Bd adowania danych: ' + error.message;
            }
        }

        function populateDropdown() {
            const select = document.getElementById('wodSelect');
            
            if (allWods.length === 0) {
                select.innerHTML = '<option value="">Brak trening贸w w bazie</option>';
                return;
            }

            select.innerHTML = '<option value="">-- Wybierz trening --</option>';
            
            allWods.forEach(wod => {
                const option = document.createElement('option');
                option.value = wod.id;
                option.textContent = wod.nazwa;
                select.appendChild(option);
            });

            select.addEventListener('change', (e) => filterTable(e.target.value));
            
            // Wyszukiwanie zawodnik贸w
            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('input', (e) => {
                const currentWod = document.getElementById('wodSelect').value;
                if (currentWod) {
                    filterTable(currentWod);
                }
            });
        }

        async function filterTable(selectedWodId) {
            const tbody = document.getElementById('tableBody');
            const table = document.getElementById('resultsTable');
            tbody.innerHTML = '';

            if (!selectedWodId) {
                table.style.display = 'none';
                return;
            }

            try {
                // Pobierz wyniki dla wybranego WOD-u
                const { data: results, error } = await supabaseClient
                    .from('wyniki')
                    .select('*, wods(nazwa, typ, jednostka)')
                    .eq('wod_id', selectedWodId);
                
                if (error) throw error;
                
                const selectedWod = allWods.find(w => w.id == selectedWodId);
                const searchText = document.getElementById('searchInput').value.toLowerCase();
                
                // Filtruj po imieniu jeli jest wyszukiwanie
                let filteredData = results;
                if (searchText) {
                    filteredData = results.filter(row => {
                        const name = (row.imie || '').toLowerCase();
                        return name.includes(searchText);
                    });
                }

                // Sortuj wyniki inteligentnie
                filteredData.sort((a, b) => {
                    const valA = parseFloat(a.wyniki) || 0;
                    const valB = parseFloat(b.wyniki) || 0;
                    
                    // For Time: mniejszy czas = lepszy (rosnco)
                    // AMRAP: wicej reps = lepszy (malejco)
                    if (selectedWod.typ === 'For Time') {
                        return valA - valB;
                    } else {
                        return valB - valA;
                    }
                });

                // Wywietl wyniki
                filteredData.forEach(row => {
                    const tr = document.createElement('tr');
                    
                    const name = row.imie || 'Anonim';
                    const category = row.kategoria || '-';
                    const wodName = row.wods?.nazwa || selectedWod.nazwa;
                    const wodType = row.wods?.typ || selectedWod.typ;
                    const wodUnit = row.wods?.jednostka || selectedWod.jednostka;
                    const score = formatScore(row.wyniki, wodType, wodUnit);

                    tr.innerHTML = `
                        <td>${name}</td>
                        <td>${category}</td>
                        <td>${wodName}</td>
                        <td>${score}</td>
                    `;
                    tbody.appendChild(tr);
                });

                table.style.display = 'table';
            } catch (error) {
                console.error('Bd pobierania wynik贸w:', error);
                tbody.innerHTML = '<tr><td colspan="4">Bd adowania wynik贸w</td></tr>';
            }
        }

        function formatScore(value, type, unit) {
            const numValue = parseFloat(value);
            
            if (isNaN(numValue)) {
                return value || '0';
            }
            
            if (type === 'For Time') {
                // Konwertuj 45.5 na 45:30 min
                const minutes = Math.floor(numValue);
                const seconds = Math.round((numValue - minutes) * 60);
                return `${minutes}:${seconds.toString().padStart(2, '0')} ${unit}`;
            } else {
                // AMRAP - po prostu liczba
                return `${Math.round(numValue)} ${unit}`;
            }
        }

        function sortTable(columnIndex) {
            const table = document.getElementById("resultsTable");
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            
            const currentDirection = table.dataset.sortDirection || 'asc';
            const newDirection = currentDirection === 'asc' ? 'desc' : 'asc';
            table.dataset.sortDirection = newDirection;

            rows.sort((a, b) => {
                const cellA = a.getElementsByTagName("TD")[columnIndex].textContent;
                const cellB = b.getElementsByTagName("TD")[columnIndex].textContent;
                
                const numA = parseFloat(cellA);
                const numB = parseFloat(cellB);

                if (!isNaN(numA) && !isNaN(numB)) {
                    return newDirection === 'asc' ? numA - numB : numB - numA;
                } else {
                    return newDirection === 'asc' 
                        ? cellA.localeCompare(cellB) 
                        : cellB.localeCompare(cellA);
                }
            });

            rows.forEach(row => tbody.appendChild(row));
        }

        // Start aplikacji
        initApp();
    </script>
</body>
</html>
